<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Home</title>
    <meta name="description" content="#" />
    <link rel="stylesheet" href="dist/css/grayshift.css" />
    <link rel="stylesheet" href="dist/css/custom.css" />
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />
    <link
      rel="stylesheet"
      href="https://rawgit.com/enyo/dropzone/master/dist/dropzone.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js"></script>
    <script src="https://timeago.yarp.com/jquery.timeago.js"></script>
    <script src="https://rawgit.com/enyo/dropzone/master/dist/dropzone.js"></script>
    <script src="config.js"></script>
  </head>

  <body>
    <div id="navigation" class="sticky-top"></div>
    <div class="container px-0 py-3">
      <h6 class="px-3 px-sm-0 py-3">Recommend</h6>
      <div id="recommend-user-row" class="row px-3 px-sm-0">
        <a
          id="recommend-user-template"
          class="nav-link d-flex flex-column align-items-center d-none mx-3"
        >
          <img class="avatar avatar-md rounded-circle border" width="100%" />
          <p class="avatar-title pt-2"></p>
        </a>
      </div>
    </div>
    <div class="container px-0">
      <h6 class="px-3 px-sm-0 py-3">Feed</h6>
      <div class="grid">
        <div class="grid-sizer"></div>
        <div class="gutter-sizer"></div>
        <div class="grid-item d-none" id="grid-item-template">
          <div class="card-body p-0">
            <a id="img-modal" href="" data-toggle="modal">
              <img class="shadow" id="grid-img" width="100%" alt="" />
            </a>
            <div
              class="modal fade z-index-higher"
              tabindex="-1"
              role="dialog"
              aria-labelledby="modalLabel"
              aria-hidden="true"
            >
              <div
                class="modal-dialog modal-lg modal-dialog-centered"
                role="document"
              >
                <div class="modal-content">
                  <img id="grid-img" width="100%" alt="" />
                </div>
              </div>
            </div>
            <div class="d-flex py-3 px-2" style="margin-bottom: 10px;">
              <a id="avatar-group" class="nav-link d-flex">
                <img
                  class="avatar avatar-xs rounded-circle align-self-center border"
                  width="100%"
                />
                <div class="ml-3 d-flex flex-column justify-content-center">
                  <p class="avatar-title"></p>
                  <p class="avatar-date"></p>
                </div>
              </a>
              <button id="like" class="btn d-flex link-body-danger ml-auto">
                <p class="avatar-title align-self-center mx-2"></p>
                <svg
                  class="gi gi-heart-outline fs-sm"
                  width="0.75em"
                  height="0.75em"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M12 21a1 1 0 0 1-.71-.29l-7.77-7.78a5.26 5.26 0 0 1 0-7.4 5.24 5.24 0 0 1 7.4 0L12 6.61l1.08-1.08a5.24 5.24 0 0 1 7.4 0 5.26 5.26 0 0 1 0 7.4l-7.77 7.78A1 1 0 0 1 12 21zM7.22 6a3.2 3.2 0 0 0-2.28.94 3.24 3.24 0 0 0 0 4.57L12 18.58l7.06-7.07a3.24 3.24 0 0 0 0-4.57 3.32 3.32 0 0 0-4.56 0l-1.79 1.8a1 1 0 0 1-1.42 0L9.5 6.94A3.2 3.2 0 0 0 7.22 6z"
                  />
                </svg>
              </button>
              <button id="download" class="btn d-flex link-headings ml-2">
                <svg
                  class="gi gi-cloud-download-outline fs-sm"
                  width="0.75em"
                  height="0.75em"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M14.31 16.38L13 17.64V12a1 1 0 0 0-2 0v5.59l-1.29-1.3a1 1 0 0 0-1.42 1.42l3 3A1 1 0 0 0 12 21a1 1 0 0 0 .69-.28l3-2.9a1 1 0 1 0-1.38-1.44z"
                  />
                  <path
                    d="M17.67 7A6 6 0 0 0 6.33 7a5 5 0 0 0-3.08 8.27A1 1 0 1 0 4.75 14 3 3 0 0 1 7 9h.1a1 1 0 0 0 1-.8 4 4 0 0 1 7.84 0 1 1 0 0 0 1 .8H17a3 3 0 0 1 2.25 5 1 1 0 0 0 .09 1.42 1 1 0 0 0 .66.25 1 1 0 0 0 .75-.34A5 5 0 0 0 17.67 7z"
                  />
                </svg>
              </button>
              <button class="btn d-flex link-headings ml-2">
                <svg
                  class="gi gi-share-outline fs-sm"
                  width="0.75em"
                  height="0.75em"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M18 15a3 3 0 0 0-2.1.86L8 12.34V12v-.33l7.9-3.53A3 3 0 1 0 15 6v.34L7.1 9.86a3 3 0 1 0 0 4.28l7.9 3.53V18a3 3 0 1 0 3-3zm0-10a1 1 0 1 1-1 1 1 1 0 0 1 1-1zM5 13a1 1 0 1 1 1-1 1 1 0 0 1-1 1zm13 6a1 1 0 1 1 1-1 1 1 0 0 1-1 1z"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="upload-modal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="modalLabel"
      aria-hidden="true"
      style="display: none;"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="fs-xs" id="modalLabel">Upload</h2>
            <button
              class="btn btn-sm btn-circle btn-neutral align-self-start"
              data-dismiss="modal"
              type="button"
              aria-label="Close"
            >
              <svg
                class="gi gi-close fs-sm"
                width="1em"
                height="1em"
                viewBox="0 0 24 24"
                fill="currentColor"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M13.41 12l4.3-4.29a1 1 0 1 0-1.42-1.42L12 10.59l-4.29-4.3a1 1 0 0 0-1.42 1.42l4.3 4.29-4.3 4.29a1 1 0 0 0 0 1.42 1 1 0 0 0 1.42 0l4.29-4.3 4.29 4.3a1 1 0 0 0 1.42 0 1 1 0 0 0 0-1.42z"
                ></path>
              </svg>
            </button>
          </div>
          <div class="modal-body rounded-bottom pt-0">
            <form
              action="/api/photo/"
              method="POST"
              enctype="multipart/form-data"
              class="dropzone"
              id="uploadForm"
            ></form>
            <button
              class="btn btn-block btn-lg btn-primary"
              type="button"
              id="upload-button"
            >
              Upload
            </button>
          </div>
        </div>
      </div>
    </div>
    <a
      class="position-fixed z-index-high"
      data-toggle="modal"
      data-target="#upload-modal"
      href=""
      style="right: var(--spacer-5); bottom: var(--spacer-5);"
    >
      <span class="icon icon-md mr-5 bg-white rounded-circle">
        <svg
          class="gi gi-plus fs-sm"
          width="1em"
          height="1em"
          viewBox="0 0 24 24"
          fill="var(--black)"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M19 11h-6V5a1 1 0 0 0-2 0v6H5a1 1 0 0 0 0 2h6v6a1 1 0 0 0 2 0v-6h6a1 1 0 0 0 0-2z"
          ></path>
        </svg>
      </span>
    </a>
    <button class="btn btn-primary" id="test-button">Test</button>
  </body>
  <script>
    const base_url = config.base_url;

    // load navbar
    $("#navigation").load("navbar.html", () => {
      fetch(base_url + "/api/auth/getLoggedInUser")
        .then((loggedInUser) => loggedInUser.json())
        .then((loggedInUser) => {
          if (loggedInUser.code == 200) {
            $("nav #nav-login-group").addClass("d-none");
            $("nav #nav-avatar-dropdown").show();
            $("#nav-avatar").attr("src", loggedInUser.data.avatar);
            $("nav #profile").attr("href", "/user");
          }
        });
    });

    fetch(base_url + "/api/photo/all")
      .then((res) => res.json())
      .then((res) => res.data)
      .then((res) => {
        let promises = [];
        for (item of res) {
          promises.push(
            Promise.resolve(item).then((item) =>
              fetch(base_url + `/api/user/public/${item.userId}`)
                .then((usr) => usr.json())
                .then((usr) => usr.data)
                .then((usr) => {
                  let grid_item = $("#grid-item-template").clone();
                  $(grid_item).attr("id", item.imgId).removeClass("d-none");
                  $(grid_item).find("#avatar-group").attr("href", "/user");
                  $(grid_item).find("#avatar-group small").append(usr.userId);
                  $(grid_item)
                    .find("#avatar-group img")
                    .attr("src", usr.avatar);
                  $(grid_item)
                    .find("#avatar-group .avatar-title")
                    .append(usr.username);
                  $(grid_item)
                    .find("#avatar-group .avatar-date")
                    .append($.timeago(item.date));
                  $(grid_item).find("#grid-img").attr("src", item.url);
                  $(grid_item)
                    .find("#img-modal")
                    .attr("data-target", "#img" + item.imgId);
                  $(grid_item)
                    .find(".modal,.fade")
                    .attr("id", "img" + item.imgId);
                  $(grid_item)
                    .find("#like p")
                    .append(item.likes + " likes");
                  $(".grid").append(grid_item);
                })
            )
          );
        }
        return Promise.all(promises);
      })
      .then(() => {
        var $grid = $(".grid").imagesLoaded(() => {
          $grid.masonry({
            itemSelector: ".grid-item",
            percentPosition: true,
            columnWidth: ".grid-sizer",
            gutter: ".gutter-sizer",
          });
        });
      });

    fetch(base_url + "/api/user/recommend")
      .then((res) => res.json())
      .then((res) => res.data)
      .then((res) => {
        for (usr of res) {
          let rec_user = $("#recommend-user-template").clone();
          $(rec_user).attr("id", usr.userId).removeClass("d-none");
          $(rec_user).find("img").attr("src", usr.avatar);
          $(rec_user).find("p").append(usr.username);
          $("#recommend-user-row").append(rec_user);
        }
      });

      $('#test-button').on('click', () => {
        fetch(base_url + "/api/photo/1b679cf08a0b11ea981829128995d111", {
          method: 'DELETE'
        }).then(res => res.json())
        .then(res => {
          console.log(res)
        })
      })

    Dropzone.options.uploadForm = {
      autoProcessQueue: false,
      addRemoveLinks: false,
      init: function (e) {
        var myDropzone = this;
        $("#upload-button").on("click", () => {
          myDropzone.processQueue();
        });
        myDropzone.on("complete", function (file) {
          if (
            this.getUploadingFiles().length === 0 &&
            this.getQueuedFiles().length === 0
          ) {
            setTimeout(() => {
              location.reload();
            }, 1500);
          }
        });
      },
    };
  </script>
</html>
